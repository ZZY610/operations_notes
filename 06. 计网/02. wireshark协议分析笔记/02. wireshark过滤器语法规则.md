# wireshark过滤器语法规则
## 概述

过滤器就是定义了一定条件，用来包含或排除满足给定条件的数据包的表达式。

wireshark过滤器有两种：抓包过滤器（`Capture filters`）和显示过滤器（`Display filters`），两者语法和功能有所差异、不可混淆。

* **抓包过滤器**：限制条件更多，用于捕获满足特定条件的数据包。在捕获开始前设置，捕获中不能修改；
* **显示过滤器**：用于分析已经捕获的数据包时过滤数据包，只显示特定的数据包。

### 抓包过滤器和显示过滤器的区别

1. 应用时间和作用范围不同。

2. 语法不同。抓包过滤器使用的是BPF语言，而显示过滤器使用的是Wireshark的显示过滤器语言。

## 1. 抓包过滤器
> 当进行抓包时，只有那些满足给定的包含/排除表达式的数据包会被捕获。

### 1.1 语法规则
使用 **BPF** 语法（Berkeley Packet Filter，在设备驱动级别提供抓包过滤接口，多数抓包工具都支持此语法）创建的过滤器被称为 `expression` （表达式），并且每个表达式包含一个或多个 `primitives` （**原语**）。每个原语包含一个或多个 `qualifiers` （限定词），然后跟着一个ID名字或数字。

---
* `Expression` ==表达式==：由一或多个原语组成，多个原语可以通过逻辑运算符 **与and（&&）、或or（||）、非not（!）** 进行组合。
    * `primitives` ==原语==：由名称或数字，以及描述它的多个限定词组成。
        * `qualifiers` ==限定词==
            * **Type**：设置数字或者名称所指示类型，例如 `host www.baidu.com`
            * **Dir**：设置网络出入方向，例如 dst port 80
            * **Proto**：指定协议类型，例如 udp
            * 其他：
                * **gateway**：指明网关 IP 地址
                * **broadcast**：广播报文，例如ether broadcast 或者 ip broadcast
                * **multicast**：多播报文，例如 ip multicast 或者 ip6 multicast 
                * **less, greater**：小于或者大于

    * 特殊语法 `proto [ expr : size]` ：   
        `proto` 即协议， `expr` 即报文字节偏移量，该偏移量相对于指定的协议层，默认的起始位置是0。 `size` 指从偏移量开始的位置提取多少个字节，默认为1。

::: tip 
**表达式**： [not] primitive [and|or [not] primitive ...

**操作符**：and（&&）、or（||）、not（!）, 代表与、或、非。
:::

---

#### 1. type类型限定词
用于限定过滤器所匹配的 **数据包的类型** 。包括数据包==主机、网络号、端口==等。

* ==host==：用于匹配IP地址，可以是单个主机、一个网络、一组主机或一个主机名；
* ==net==：用于匹配IP网络；
* ==port==：用于匹配端口号，可以是单个端口、一组端口或者一个服务名；
* portrange：用于匹配端口号范围；
* portexpr：可以使用任意复杂的算术或逻辑表达式。

#### 2. dir类型限定词
用于限定过滤器所匹配的数据包的流向。

* src：表示源地址
* dst：表示目的地址
* src or dst：表示源地址或目的地址，
* src and dst：表示同时满足源地址和目的地址。

#### 3. proto类型限定词
proto类型限定词用于限定过滤器所匹配的数据包的协议类型。

* proto类型限定词包括tcp、udp、icmp、arp、ip、http等。

---

| 限定词 | 说明 | 例子 |
| -- | -- | -- |
| **type** 类型 | 匹配数据包的类型，说明其后的ID或数字的含义 | `host`, `net`, `port`, `mask` 和 `portrange` (*默认`host`*)|
| **dir** 方向 | 指定了数据传输方向。 | `src`, ``dst``, `src or dst`, `src and dst` (*默认 `src or dst`*)|
| **proto** 协议 | 过滤指定协议的数据包。 | `ether`, `ip`, `ip6`, `arp`, `tcp` 和 `udp` (`默认和 type 一致的所有协议`) |

### 1.2 例子

1. 只抓取源或目的IP地址为192.168.43.2的流量：
> host 192.168.43.2
2. 抓取 ==一类== 源或目的IP地址的流量：
> net 192.168.0.0/24
> net 192.168.0.0 mask 255.255.255.0
3. 抓取来自/去向某一类IP地址的流量：
> src/dst net 192.168.0.0/24
> src/dst net 192.168.0.0 mask 255.255.255.0
4. 抓取UDP数据包：
> UDP/port 53
5. 抓取某个服务器上非HTTP和非SMTP的数据包。
> host www.example.com and not (port 80 or port 25)
> host www.example.com and not port 80 and not port 25

6. 抓取除了ARP和DNS协议的其他数据包。
> port not 53 and not arp
7. 抓取多个端口的数据包：
> tcp *portrange* 1501-1549
8. 拒收数据链路层发现协议LLDP帧：
> not ether dst 01:80:c2:00:00:0e

9. 拒收广播和多播数据包 
> not broadcast and not multicast
 
10. 捕获每个TCP会话的起始和结束报文(SYN 和 FIN 报文):
> tcp[13] & 3 != 0
## 2. 显示过滤器
> 该过滤器根据指定的表达式用于一个已捕获的数据包集合，它将隐藏不想显示的数据包或者只显示那些需要的数据包。

### 2.1 语法规则
#### 布尔表达式结构

显示过滤器的语法以==某一具体协议==为中心，遵从 `protocol.feature.subfeature` 的形式。

* **关系运算符**：对某一字段进行值的比较

| 操作符 | 说明 |
| -- | -- |
| != | 不等于 |
| > | 大于 |
| < | 小于 |
| >= | 大于等于 |
| <= | 小于等于 |

* **逻辑运算符**：将多个过滤器表达式合并到一个语句中。

| 操作符 | 说明 |
| -- | -- |
| and | 与 |
| or | 或 |
| xor | 异或（相同为0，不同为1），有且仅有一个条件被满足 |
| not | 非 |

#### 显示过滤器对话框

* 显示过滤器表达式：`analyze -> display filter expression`
![Img](./FILES/02.%20wireshark过滤器语法规则.md/img-20230306091313.png)
选择**字段名称（field name）**、**关系运算符relation**、**条件值value**，即可构建显示表达式。

#### 在工具栏（Toolbar）中增加显示过滤器
把频繁使用的显示过滤器添加到过滤器工具栏中以方便调用。

点击显示过滤器工具栏最右侧的＋号，输入过滤器、名字、标签、注释即可。

### 2.2 例子

1.  过滤指定IP地址的数据包
`ip.addr == 192.168.0.1`可以过滤源IP地址或目的IP地址为192.168.0.1的数据包。

2.  过滤指定端口号的数据包
使用`tcp.port`或`udp.port`过滤指定端口号的数据包
* `tcp.port == 80`：过滤端口号为80的TCP数据包
* `udp.port == 53`：过滤端口号为53的UDP数据包。

3.  过滤指定协议的数据包
`http`：过滤HTTP协议的数据包
`dns`：过滤DNS协议的数据包。

4.  过滤指定数据包大小的数据包
使用`frame.len`过滤指定数据包大小的数据包。`frame.len > 1000`：过滤大小超过1000字节的数据包。

5.  组合过滤条件
可以通过使用逻辑运算符`and`、`or`和`not`来组合多个过滤条件。
* `ip.addr == 192.168.0.1 and tcp.port == 80`可以过滤源IP地址为192.168.0.1且端口号为80的TCP数据包。

6.  使用表达式
还可以使用表达式来过滤数据包，例如：`ip.addr == 192.168.0.1 and tcp.len > 0`可以过滤源IP地址为192.168.0.1且TCP数据包长度大于0的数据包。表达式的语法可以参考Wireshark的官方文档。

7. 显示具有SYN标志位的tcp数据包
> tcp.flags.syn == 1

8. 显示文本Email流量
> smtp || pop || imap


## 3. 保存自定义过滤器表达式

### 保存捕获过滤器
* capture -> capture filters 可以添加已有的捕获过滤器表达式。

### 保存显示过滤器
* analyze -> display filters 可以添加已有的显示过滤器表达式。
* 或者点击显示器工具栏前的书签标志。
