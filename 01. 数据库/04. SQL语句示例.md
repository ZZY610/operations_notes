# 04. SQL语句示例
# 基本表数据操作 SQL 示例

## 1. 数据定义语言 (DDL) - 创建和修改表结构

### 创建表
```sql
-- 创建学生表
CREATE TABLE students (
    student_id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    date_of_birth DATE,
    enrollment_date DATE DEFAULT CURRENT_DATE,
    CONSTRAINT chk_student_age CHECK (date_of_birth <= '2010-01-01')
);

-- 创建课程表
CREATE TABLE courses (
    course_id INT PRIMARY KEY AUTO_INCREMENT,
    course_name VARCHAR(100) NOT NULL,
    credits INT DEFAULT 3,
    department VARCHAR(50),
    CONSTRAINT uq_course_name UNIQUE (course_name)
);

-- 创建学生选课表（连接表）
CREATE TABLE student_courses (
    enrollment_id INT PRIMARY KEY AUTO_INCREMENT,
    student_id INT NOT NULL,
    course_id INT NOT NULL,
    enrollment_date DATE DEFAULT CURRENT_DATE,
    grade DECIMAL(3, 2) CHECK (grade BETWEEN 0 AND 4.0),
    FOREIGN KEY (student_id) REFERENCES students(student_id) ON DELETE CASCADE,
    FOREIGN KEY (course_id) REFERENCES courses(course_id) ON DELETE RESTRICT,
    CONSTRAINT uq_student_course UNIQUE (student_id, course_id)
);
```

### 修改表结构
```sql
-- 添加新列
ALTER TABLE students ADD COLUMN phone_number VARCHAR(15);

-- 修改列定义
ALTER TABLE students MODIFY COLUMN email VARCHAR(150);

-- 重命名列
ALTER TABLE students RENAME COLUMN phone_number TO contact_number;

-- 删除列
ALTER TABLE students DROP COLUMN contact_number;

-- 添加外键约束
ALTER TABLE student_courses 
ADD CONSTRAINT fk_student
FOREIGN KEY (student_id) REFERENCES students(student_id);

-- 删除表
DROP TABLE IF EXISTS student_courses;
```

## 2. 数据操作语言 (DML) - 增删改数据

### 插入数据
```sql
-- 插入单条记录
INSERT INTO students (first_name, last_name, email, date_of_birth)
VALUES ('张三', '李', 'zhangsan@example.com', '2000-05-15');

-- 插入多条记录
INSERT INTO students (first_name, last_name, email, date_of_birth)
VALUES 
('王', '五', 'wangwu@example.com', '2001-03-22'),
('赵', '六', 'zhaoliu@example.com', '1999-11-08');

-- 插入选课记录
INSERT INTO student_courses (student_id, course_id, grade)
SELECT s.student_id, c.course_id, 3.8
FROM students s, courses c
WHERE s.last_name = '李' AND c.course_name = '数据库原理';
```

### 更新数据
```sql
-- 更新单条记录
UPDATE students 
SET email = 'new_email@example.com'
WHERE student_id = 1;

-- 更新多条记录
UPDATE students 
SET enrollment_date = '2023-09-01'
WHERE enrollment_date IS NULL;

-- 使用子查询更新
UPDATE student_courses
SET grade = grade + 0.1
WHERE student_id IN (
    SELECT student_id 
    FROM students 
    WHERE last_name = '李'
);

-- 使用JOIN更新
UPDATE student_courses sc
JOIN students s ON sc.student_id = s.student_id
SET sc.grade = 4.0
WHERE s.last_name = '王' AND sc.grade < 3.5;
```

### 删除数据
```sql
-- 删除特定记录
DELETE FROM students 
WHERE student_id = 5;

-- 删除符合条件的所有记录
DELETE FROM student_courses
WHERE grade < 1.0;

-- 使用子查询删除
DELETE FROM students
WHERE student_id NOT IN (
    SELECT DISTINCT student_id 
    FROM student_courses
);

-- 清空整个表（不可回滚）
TRUNCATE TABLE student_courses;

-- 删除所有记录（可回滚）
DELETE FROM students;
```

## 3. 数据查询语言 (DQL) - 查询数据

```sql
-- 简单查询
SELECT * FROM students;

-- 条件查询
SELECT first_name, last_name, email
FROM students
WHERE date_of_birth > '2000-01-01'
ORDER BY last_name, first_name;

-- 连接查询
SELECT s.first_name, s.last_name, c.course_name, sc.grade
FROM students s
JOIN student_courses sc ON s.student_id = sc.student_id
JOIN courses c ON sc.course_id = c.course_id
WHERE sc.grade > 3.0;

-- 聚合查询
SELECT 
    c.course_name,
    COUNT(sc.student_id) AS enrolled_students,
    AVG(sc.grade) AS average_grade,
    MAX(sc.grade) AS max_grade,
    MIN(sc.grade) AS min_grade
FROM courses c
LEFT JOIN student_courses sc ON c.course_id = sc.course_id
GROUP BY c.course_id, c.course_name
HAVING AVG(sc.grade) > 2.5 OR AVG(sc.grade) IS NULL;

-- 子查询
SELECT first_name, last_name
FROM students
WHERE student_id IN (
    SELECT student_id
    FROM student_courses
    WHERE grade = (SELECT MAX(grade) FROM student_courses)
);
```

## 4. 事务控制

```sql
-- 开始事务
START TRANSACTION;

-- 插入选课记录
INSERT INTO student_courses (student_id, course_id, grade)
VALUES (1, 1, 3.5);

-- 更新学生信息
UPDATE students 
SET enrollment_date = CURRENT_DATE
WHERE student_id = 1;

-- 根据条件提交或回滚
IF /* 某些条件 */ THEN
    COMMIT; -- 提交事务
ELSE
    ROLLBACK; -- 回滚事务
END IF;
```

## 5. 约束管理

```sql
-- 禁用外键约束检查（慎用）
SET FOREIGN_KEY_CHECKS = 0;

-- 启用外键约束检查
SET FOREIGN_KEY_CHECKS = 1;

-- 添加新约束
ALTER TABLE students
ADD CONSTRAINT chk_valid_email 
CHECK (email LIKE '%@%.%');

-- 删除约束
ALTER TABLE students
DROP CHECK chk_student_age;

-- 创建索引提高查询性能
CREATE INDEX idx_student_name ON students(last_name, first_name);
CREATE INDEX idx_course_department ON courses(department);

-- 删除索引
DROP INDEX idx_student_name ON students;
```

## 6. 视图和存储过程

```sql
-- 创建视图
CREATE VIEW student_grades AS
SELECT 
    s.student_id,
    s.first_name,
    s.last_name,
    c.course_name,
    sc.grade
FROM students s
JOIN student_courses sc ON s.student_id = sc.student_id
JOIN courses c ON sc.course_id = c.course_id;

-- 使用视图查询
SELECT * FROM student_grades WHERE grade > 3.5;

-- 创建存储过程
DELIMITER //
CREATE PROCEDURE enroll_student(
    IN p_student_id INT,
    IN p_course_id INT,
    OUT p_result VARCHAR(100)
)
BEGIN
    DECLARE existing_enrollment INT;
    
    -- 检查是否已经选课
    SELECT COUNT(*) INTO existing_enrollment
    FROM student_courses
    WHERE student_id = p_student_id AND course_id = p_course_id;
    
    IF existing_enrollment > 0 THEN
        SET p_result = '学生已经选修此课程';
    ELSE
        -- 插入选课记录
        INSERT INTO student_courses (student_id, course_id)
        VALUES (p_student_id, p_course_id);
        
        SET p_result = '选课成功';
    END IF;
END //
DELIMITER ;

-- 调用存储过程
CALL enroll_student(1, 2, @result);
SELECT @result;
```