# 数据库编程

## 1. 数据库应用开发概述

### 1.1 数据库应用开发过程

数据库应用系统的开发过程一般包括以下阶段：

*   需求分析
    *   系统需求包括 **数据的需求** 和 **处理的需求** 两方面内容。这一阶段要摸清现状，理清将要开发的目标系统应具有哪些功能。
    *   描述用户需求传统的方法大多采用结构化的分析方法（Structured Analysis，SA），即按应用部门的组织结构，对系统内部的数据流进行分析，逐层细化，用==数据流图==（Data Flow Diagram，DFD）描述数据在系统中的流动和处理，并建立相应的==数据字典==（Data Dictionary，DD）。

*   总体设计
    *   总体设计的目标是使应用系统总体结构具有层次性，尽量降低模块接口的复杂度。进行总体设计时，可提出多种设计方案，并在功能、性能、成本、进度等方面对各种方案进行比较，选出一种“最佳方案”。

*   详细设计
    *   详细设计的目标是对概要设计产生的功能模块进一步细化，形成可编程的结构模块，并设计各模块的单元测试计划。

*   编码与单元测试
    *   编码与单元测试的主要任务为：编写实现各功能模块的程序代码，并进行相应的测试。编码阶段应注意遵循编程标准、养成良好的编程风格，以便编写出正确的便于理解、调试和维护的程序模块。

*   系统测试与交付

*   系统使用与维护

### 1.2 数据库应用系统的体系结构

数据库应用系统的体系结构是指数据库应用系统各组成部件之间的结构关系。

可分为4种模式：

*   单用户模式
*   主从式多用户模式
*   客户/服务器模式 (Client/Server, ==C/S== )
*   **Web浏览器/服务器模式** (Browser/Server, ==B/S== )

#### 单用户模式

*   单用户模式的数据库应用系统，将数据库、DBMS和应用程序安装在一台计算机上。
*   由一个用户独占系统，不同系统之间不能共享数据。

#### 主从式多用户模式

*   主从式多用户数据库应用系统，将数据库、DBMS和应用程序安装在主机上，多个终端用户使用主机上的数据和程序。
*   在这种结构中，所有处理任务都是由主机完成的。
*   用户终端没有应用逻辑，它向主机发出请求，由主机响应请求后返回处理的结果。
*   当终端用户增加到一定程度时，主机任务就会过分繁重，形成瓶颈，系统性能就会严重下降。

#### C/S模式

![Img](./FILES/04.%20数据库编程.md/img-20230322154507.png)

#### B/S模式

![Img](./FILES/04.%20数据库编程.md/img-20230322154519.png)

## 2. SQL程序设计基础

### 过程化SQL

*   SQL-99标准中提出了 `SQL-invoked routines` 概念，意为引用SQL的例行程序。
*   `SQL-invoked routines` 分为 ==存储过程== 和 ==函数== 两类。
*   为了能建立 `SQL-invoked routines` ，一些RDBMS对SQL进行==过程化==扩展，主要增加一些类似高级程序设计语言的基本语法要素。
    *   Oracle提供了PL/SQL（*Procedural Language*/SQL）
    *   SQL Server提供了T-SQL过程化扩展。
        SQL过程化扩展结合了SQL的数据操作能力和过程化语言的流程控制能力（类似Java的**方法**），使其可用于建立==存储过程==或==函数==，或建立其他可编程对象。

### 常量

### 变量

### 运算符与表达式
1.  算术运算符：用于执行基本的算术运算，如加、减、乘、除等。常见的算术运算符包括加号（+）、减号（-）、乘号（\*）、除号（/）等。
    
```sql
set serveroutput on;
BEGIN  
   dbms_output.put_line( 10 + 5); 
   dbms_output.put_line( 10 - 5); 
   dbms_output.put_line( 10 * 5); 
   dbms_output.put_line( 10 / 5); 
   dbms_output.put_line( 10 ** 5); 
END; 
```


2.  比较运算符：用于比较两个值或表达式的大小或相等性。常见的比较运算符包括等于号（=）、不等于号（!=或<>）、大于号（>）、小于号（<）、大于等于号（>=）和小于等于号（<=）等。
    
3.  逻辑运算符：用于执行逻辑运算，如AND、OR、NOT等。常见的逻辑运算符包括AND、OR、NOT等。
    
4.  位运算符：用于对二进制位进行操作，如按位与、按位或、按位异或等。常见的位运算符包括AND、OR、XOR、NOT、左移（<<）和右移（>>）等。
    
5.  赋值运算符：用于将一个值或表达式的结果赋值给一个变量或存储过程参数。常见的赋值运算符包括等号（=）、PL/SQL兼容的等号（:=）、加等于（+=）、减等于（-=）、乘等于（\*=）和除等于（/=）等。
    
6.  成员运算符：（IN、LIKE、BETWEEN等）

#### 运算符优先级
在 PL/SQL 中，运算符优先级是指在一个表达式中，不同运算符的执行顺序。当一个表达式中包含多个运算符时，会根据优先级决定先执行哪些运算符，以保证表达式的正确计算。

下表列出了 PL/SQL 中常见运算符的优先级（从高到低），相同优先级的运算符按照从左到右的顺序执行：

| 运算符 | 描述 |
| --- | --- |
| ** | 幂指运算符 |
| + \- | 标识符，取正号负号 |
| \* / | 乘法、除法 |
| \+ - | 加法、减法 |
| \|\| | 字符串连接 |
| \= > < >= <= <> != ^= | 比较运算符 |
| NOT | 逻辑非 |
| AND | 逻辑与 |
| OR | 逻辑或 |
| XOR | 逻辑异或 |
| << >> | 位移运算符 |
| ^ | 位异或 |
| & | 位与 |
| \| | 位或 |
| NOT IN | 集合测试运算符 |
| IN | 集合测试运算符 |
| LIKE | 字符串模式匹配 |
| BETWEEN | 范围测试 |
| IS NULL | 测试是否为 NULL |
| \= | 赋值运算符 |


可以看到，优先级最高的是取负运算符和指数运算符，其次是乘法、除法和取模运算符，然后是加法和减法运算符，最后是比较运算符、逻辑运算符和赋值运算符。在表达式中，运算符的优先级是不能改变的，如果需要改变运算顺序，可以使用圆括号（()）明确运算次序。

### 流程控制语句

| 控制语句       | 功能 |
| ---------- | ----------- |
| BEGIN..END | 定义语句块 |
| IF..ELSE   | 条件语句 |
| WHILE      | 循环语句 |
| CONTINUE   | 用于重新开始下一次循环 |
| BREAK      | 用于退出最内层循环 |
| GOTO       | 无条件转移语句 |
| RETURN     | 无条件返回语句 |
| WAITFOR    | 为语句的执行设置延迟 |

#### BEGIN END
* plSQL程序的基本结构是==语句块==，每个块作为一个整体处理，完成逻辑操作。
    * 一个语句块内可包含任意多条SQL语句。
    * 通常用于创建存储过程、函数、触发器等程序逻辑单元。
* `BEGIN...END` 语法结构如下：
```sql
DECLARE 
   <declarations section> 
BEGIN 
   <executable command(s)>
EXCEPTION 
   <exception handling> 
END;
```
* 语句块之间可以相互嵌套。 

#### IF ELSE
IF...ELSE语句的格式为：

```sql
IF <条件表达式>
   { 语句1 | 语句块1 }          --条件表达式为真时执行 
[ ELSE
   { 语句2 | 语句块2 } ]       --条件表达式为假时执行 
```
#### WHILE
```sql
 WHILE循环语句格式为：
WHILE <逻辑表达式> 
      { <语句> | <语句块> } 
```

#### BREAK、 CONTINUE
* BREAK语句一般用在WHILE循环语句中，用于退出本层循环。当程序中有多层循环嵌套时，使用BREAK语句只能退出其所在的这一层循环。 

* CONTINUE语句一般用在循环语句中，用以结束本次循环，重新转到下一次循环条件的判断。

#### RETURN
* RETURN语句用于从过程、批处理或语句块中无条件退出。
* RETURN语句的格式为：
```sql
RETURN [ <表达式> ]
```
* 其中，<表达式>为整型，表示返回的状态码。
* 通常，在存储过程中用RETURN语句给调用过程或应用程序返回整型值。而从语句块中跳出则使用不带表达式的RETURN语句。

## 函数

### 内置函数
### 用户定义函数

## 存储过程与触发器

### 存储过程

*   存储过程是存储在服务器上的一组==预先定义==的SQL程序，它是一种**封装重复任务**的方法。存储过程可以反复调用，便于共享及维护。

使用存储过程的优点主要有：

1.  存储过程在==服务器端==运行，执行效率高。
2.  存储过程执行一次后，其执行规划就驻留在高速缓冲存储器中，在以后的操作中，只需从高速缓冲存储器中调用已编译好的二进制代码执行即可，提高了系统性能。
3.  确保数据库的安全。使用存储过程可以完成所有数据库操作，并可通过编程方式控制上述操作对数据库信息访问的权限。
4.  自动完成需要预先执行的任务。存储过程可以在系统启动时自动执行，而不必在系统启动后再进行手工操作，大大方便了用户的使用，可以自动完成一些需要预先执行的任务。

### 触发器

*   触发器是一类可由特定事件触发的SQL程序块，其主要用途在于可以动态地维护数据一致性。
    *   实际业务中用得少

