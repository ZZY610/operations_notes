# 基础知识

## 1. Tomcat 是什么？
Tomcat 是一个 **开源、轻量级、纯 Java 写的 “HTTP 服务器 + Servlet 容器”**。  
它既能像 Nginx 一样“把静态文件吐给浏览器”，也能像“Java 后端发动机”一样运行你用 Spring/Servlet/JSP 写的代码。


### 1.1 发展历史
• 1998 年：Apache Jakarta 子项目诞生，原名 **Jakarta Tomcat**。  
• 2005 年：成为 Apache 顶级项目，版本号从 3.x → 9.x → 10.x（10 开始包名从 `javax.servlet.*` 改为 `jakarta.servlet.*`）。  
• 双许可证：Apache License 2.0，可商用可改。

### 1.2 体系结构总览
```
Server
 ├── Service
 │    ├── Connector（HTTP/HTTPS/AJP）
 │    └── Engine
 │         ├── Host(虚拟主机)
 │         │    ├── Context(一个 Web 应用)
 │         │    └── Context...
 │         └── Host...
 └── Service...
```
- **Server**：整个 Catalina 实例（一个 JVM 里只能有一个）。  
- **Service**：把 Connector 和 Engine 绑在一起（99% 场景只有一个 Service）。  
- **Connector**：真正“监听端口”的组件，负责字节 ↔ Tomcat Request/Response 对象。  
- **Engine**：收到 Connector 交来的请求后，开始“找虚拟主机 → 找应用”的派发。  
- **Host**：对应“域名”或“ip:port”的虚拟主机。  
- **Context**：对应 **一个 WAR/一个目录** 的 Web 应用，内部再映射到你的 Servlet 类。

────────────────────────
### 1.3 安装目录
（假设解压到 /opt/tomcat）
```
bin/
   startup.sh  shutdown.sh  catalina.sh  (核心脚本)
conf/
   server.xml      (全局配置)
   web.xml         (全局缺省 web 配置)
   tomcat-users.xml(登录管理后台的账号)
lib/
   *.jar           (Tomcat 自身和公共类库)
webapps/
   ROOT/           (默认小猫)
logs/
   catalina.out    (所有 stdout)
   localhost.log   (应用级日志)
work/
   编译后的 JSP 临时文件
temp/
   运行期临时目录
```

────────────────────────
### 1.4 启动脚本到底做了什么？
```
startup.sh  → catalina.sh start
            → java org.apache.catalina.startup.Bootstrap start
```
Bootstrap 做的事：  
1. 创建 Server 实例（反射 new Catalina()）。  
2. 解析 conf/server.xml → 构建前面那张“体系结构图”。  
3. 启动所有 Connector 线程（默认 HTTP/1.1 8080）。  
4. 进入 await()，等待 shutdown 端口发来的 SHUTDOWN 字符串。

────────────────────────
### 1.5 默认配置速读（server.xml 最核心 5 行）
```xml
<Server port="8005" shutdown="SHUTDOWN">
  <Service name="Catalina">
    <Connector port="8080" protocol="HTTP/1.1"/>
    <Engine name="Catalina" defaultHost="localhost">
      <Host name="localhost" appBase="webapps"/>
    </Engine>
  </Service>
</Server>
```
• `port="8080"`：浏览器访问的端口。  
• `appBase="webapps"`：Host 自动把 webapps 下的每个目录/WAR 当作一个 Context。  
• `port="8005"`：本地关闭端口，只能本机连，发 “SHUTDOWN” 即可优雅停机。

────────────────────────
### 1.6 第一个请求的一生（时序图）
```
浏览器 ──TCP SYN──> 8080 (Connector)
        <─SYN-ACK─
        ──HTTP GET /hello──>
Connector → CoyoteAdapter → StandardEngineValve
          → Host → Context → Wrapper → YourServlet.service()
          ← 200 OK ←
```

────────────────────────
7. 部署三种姿势
| 方法 | 动作 | 结果 |
|---|---|---|
| 目录部署 | 把 `myapp/` 放进 webapps | 自动映射 `/myapp` |
| 打 WAR | 把 `myapp.war` 放进去 | 自动解压、热部署 |
| 热加载 | `conf/Catalina/localhost/myapp.xml` 指定 docBase | 不改 server.xml |

────────────────────────
8. 默认 Web 应用列表
```
/              ROOT
/docs          官方文档
/examples      Servlet/JSP 示例
/host-manager  虚拟主机管理
/manager       Web 应用管理（需要账号）
```

────────────────────────
9. 日志体系 3 级
• **catalina.out** – JVM 标准输出（System.out/err）。  
• **localhost.yyyy-MM-dd.log** – 具体应用抛异常的地方。  
• **access_log.yyyy-MM-dd.txt** – 类似 Nginx 的访问日志。

────────────────────────
10. 最小可用配置（不碰 server.xml 也能跑）
```
$ /opt/tomcat/bin/startup.sh
$ echo '<h1>Hello Tomcat</h1>' > /opt/tomcat/webapps/ROOT/hello.html
```
浏览器访问：http://<ip>:8080/hello.html

────────────────────────
11. 常用命令速查
```
启动        ./startup.sh
停止        ./shutdown.sh
实时日志    tail -f logs/catalina.out
端口占用    ss -lntp | grep java
查看线程    jstack <pid>
```

────────────────────────
12. 一句话总结
Tomcat = “监听 8080 的 Java 程序”，它把 HTTP 报文翻译成 `request/response` 对象，再按 `Host→Context→Servlet` 的层级把请求递给你的代码，最后把结果按 HTTP 发回浏览器。